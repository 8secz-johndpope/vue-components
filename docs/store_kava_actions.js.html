<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: store/kava/actions.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: store/kava/actions.js</h1>






    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import Irisnet from 'irisnet-crypto';
import { signMsg } from '../../helpers/ledger';

import {
  // LEDGER_REDELEGATE_MEMO,
  LEDGER_DELEGATE_MEMO,
  // LEDGER_UNBOND_MEMO,
  // LEDGER_REWARDCLAIM_MEMO,
  // LEDGER_VOTE_MEMO,
} from '../../config/index';

import {
  // fetchKavaTxByHash,
  postKavaSignedTx,
} from '../../services/api';


/**
 * @function beginDelegation
 * @description creates delegation transaction, awaits signature, sends to networkConstants
 */
export const beginDelegation = async ({ dispatch, rootState }) => {
  try {
    const msg = {
      validator_addr: rootState.delegation.targetProvider.operator_address,
      delegator_addr:
        rootState.ledger.account[rootState.session.networkConfig.networkNameLC].address,
      amount: {
        denom: rootState.session.networkConfig.delegationDenom,
        amount: rootState.delegation.delegationAmount * 1000000,
      },
    };

    const request = {
      chain_id: rootState.session.networkConfig.chainID,
      from: rootState.ledger.account[rootState.session.networkConfig.networkNameLC].address,
      account_number:
        rootState.ledger.account[rootState.session.networkConfig.networkNameLC].account_number,
      sequence: rootState.ledger.account[rootState.session.networkConfig.networkNameLC].sequence,
      fees: {
        denom: rootState.session.networkConfig.delegationDenom,
        amount: rootState.session.networkConfig.fee,
      },
      gas: rootState.session.networkConfig.gas,
      memo: LEDGER_DELEGATE_MEMO,
      type: 'delegate',
      msg,
    };

    dispatch('buildSignSendKavaTx', request);
  } catch (e) {
    throw new Error(e);
  }
};

// /**
//  * @function beginRedelegation
//  * @description creates delegation transaction, awaits signature, sends to networkConstants
//  */
// export const beginRedelegation = async ({
//   rootState,
//   dispatch,
// }) => {
//   try {
//     const msg = {
//       validator_src_addr:
//         rootState.delegation.delegationParams.selectedAccount.delegations
//           .validator_address,
//       validator_dst_addr: rootState.delegation.delegationConfig.delegateAddress,
//       amount: {
//         denom: UATOM,
//         amount: parseFloat(rootState.delegation.delegationParams.amount),
//       },
//     };
//
//     // Delegate request (change type to undelegate for unbonding / un-delegate)
//     const request = {
//       chain_id: KAVAMAINNET,
//       from: rootState.delegation.delegationParams.selectedAccount.address,
//       account_number:
//         rootState.delegation.delegationParams.selectedAccount.account_number,
//       sequence: rootState.delegation.delegationParams.selectedAccount.sequence,
//       fees: {
//         denom: UATOM,
//         amount: KAVAFEEAMOUNT,
//       },
//       gas: KAVAGAS,
//       memo: LEDGER_REDELEGATE_MEMO,
//       type: 'begin_redelegate',
//       msg,
//     };
//     if (msg.validator_src_addr === msg.validator_dst_addr) {
//       throw new Error('A redelegation transaction to the same validator will fail.');
//     }
//     dispatch('buildSignSendKavaTx', request);
//   } catch (e) {
//     dispatch('errorMessage', e.toString());
//   }
// };
//
// /**
//  * @function beginUnbonding
//  * @description creates unbonding transaction, awaits signature, sends to networkConstants
//  */
// export const beginUnbonding = async ({
//   rootState,
//   dispatch,
// }) => {
//   try {
//     // Delegate message (same for unbonding)
//     const msg = {
//       validator_addr: rootState.delegation.delegationConfig.delegateAddress,
//       amount: {
//         denom: UATOM,
//         amount: rootState.delegation.delegationParams.amount,
//       },
//     };
//
//     // Delegate request (change type to undelegate for unbonding / un-delegating)
//     const request = {
//       chain_id: KAVAMAINNET,
//       from: rootState.delegation.delegationParams.selectedAccount.address,
//       account_number:
//         rootState.delegation.delegationParams.selectedAccount.account_number,
//       sequence: rootState.delegation.delegationParams.selectedAccount.sequence,
//       fees: {
//         denom: UATOM,
//         amount: KAVAFEEAMOUNT,
//       },
//       gas: KAVAGAS,
//       memo: LEDGER_UNBOND_MEMO,
//       type: 'undelegate',
//       msg,
//     };
//     if (msg.validator_src_addr === msg.validator_dst_addr) {
//       throw new Error('A redelegation transaction to the same validator will fail.');
//     }
//
//     dispatch('buildSignSendKavaTx', request);
//   } catch (e) {
//     dispatch('errorMessage', e.toString());
//   }
// };
//
//
// /**
//  * @function govVote
//  */
// export const govVote = async ({
//   rootState,
//   dispatch,
// }) => {
//   try {
//     // Delegate message (same for unbonding)
//     const msg = {
//       proposal_id: rootState.delegation.delegationConfig.delegateAddress,
//       voter: 'asdf',
//       option: 'Yes',
//     };
//
//     // Delegate request (change type to undelegate for unbonding / un-delegating)
//     const request = {
//       chain_id: GAIA,
//       from: rootState.delegation.delegationParams.selectedAccount.address,
//       account_number:
//         rootState.delegation.delegationParams.selectedAccount.account_number,
//       sequence: rootState.delegation.delegationParams.selectedAccount.sequence,
//       fees: {
//         denom: 'umuon',
//         amount: KAVAFEEAMOUNT,
//       },
//       gas: KAVAGAS,
//       memo: LEDGER_VOTE_MEMO,
//       type: 'vote',
//       msg,
//     };
//
//     dispatch('buildSignSendKavaTx', request);
//   } catch (e) {
//     dispatch('errorMessage', e.toString());
//   }
// };
//
//
/**
 * @function buildSignSendKavaTx
 * @description Constructs the transaction,
 sends to ledger for signature, and sends to networkConstants
 * @param  {Object} request   {the raw transaction request for the Msg type to build}
 */
export const buildSignSendKavaTx = async ({ rootState, dispatch }, request) => {
  try {
    const builder = Irisnet.getBuilder(rootState.session.networkConfig.networkNameLC);
    const accountHDPATH = rootState.ledger.HDPATH;

    // create a stdTx from the request object
    const stdTx = builder.buildTx(JSON.parse(JSON.stringify(request)));

    // get the portions of the tx to sign
    const signBytes = stdTx.GetSignBytes();

    // get the signatures from a ledger signing action
    const sigs = await signMsg(accountHDPATH, signBytes);

    // get the portion of the stdTx for attaching signature(s)
    const txData = stdTx.GetData();

    // attach signatures
    txData.tx.signatures = sigs;


    // send tx to node
    const txResponse = await postKavaSignedTx(txData);
    console.log(txResponse);
    // commit('ledger/SET_TX_HASH', txResponse.data.txhash, {
    //   root: true,
    // });
    // if (txResponse.data.logs[0].success === true) {
    //   commit('delegation/SET_ACTIVE_DELEGATION_PROMPT', 'TxSuccessPrompt', {
    //     root: true,
    //   });
    // } else {
    //   dispatch(
    //     'delegation/toggleLoadingModal', {
    //       visible: true,
    //       header: '',
    //       footer: 'Broadcasting signed transaction to the networkConstants..',
    //     }, {
    //       root: true,
    //     },
    //   );

    //   const delay = 30000;

    //   setTimeout(() => {
    //     dispatch(
    //       'checkKavaTxStatus',
    //     );
    //   }, delay);
    // }
  } catch (e) {
    dispatch('session/logError', e, { root: true });
  } finally {
    dispatch('session/logDelegationRecord', null, { root: true });
  }
};
//
// // message MsgDeposit {
// //   required int64 proposalID = 1;
// //   required bytes depositor = 2;
// //   repeated Coin amount = 3;
// // }
//
// // message MsgVote {
// //   required int64 proposalID = 1;
// //   required bytes voter = 2;
// //   required uint64 option = 3;
// // }
// /**
//  * @function govDeposit
//  */
// export const govDeposit = async ({
//   rootState,
//   dispatch,
// }) => {
//   try {
//     // Delegate message (same for unbonding)
//     const msg = {
//       validator_addr: rootState.delegation.delegationConfig.delegateAddress,
//       amount: {
//         denom: UATOM,
//         amount: rootState.delegation.delegationParams.amount,
//       },
//     };
//
//     // Delegate request (change type to undelegate for unbonding / un-delegating)
//     const request = {
//       chain_id: KAVAMAINNET,
//       from: rootState.delegation.delegationParams.selectedAccount.address,
//       account_number:
//         rootState.delegation.delegationParams.selectedAccount.account_number,
//       sequence: rootState.delegation.delegationParams.selectedAccount.sequence,
//       fees: {
//         denom: UATOM,
//         amount: KAVAFEEAMOUNT,
//       },
//       gas: KAVAGAS,
//       memo: LEDGER_UNBOND_MEMO,
//       type: 'undelegate',
//       msg,
//     };
//     if (msg.validator_src_addr === msg.validator_dst_addr) {
//       throw new Error('A redelegation transaction to the same validator will fail.');
//     }
//
//     dispatch('buildSignSendKavaTx', request);
//   } catch (e) {
//     dispatch('session/logError', e, { root: true });
//   }
// };
//
//
// /**
//  * @function withdrawAllRewards
//  * @description creates delegation transaction, awaits signature, sends to networkConstants
//  */
// export const withdrawAllRewards = async ({
//   dispatch,
//   rootState,
//   commit,
// }) => {
//   try {
//     const msg = {
//       validator_addr: rootState.ledger.cosmosAccount.delegations[0].validator_address,
//     };
//     // Delegate request (change type to undelegate for unbonding/undelegation)
//     const request = {
//       chain_id: KAVAMAINNET,
//       from: rootState.ledger.cosmosAccount.address,
//       account_number: rootState.ledger.cosmosAccount.account_number,
//       sequence: rootState.ledger.cosmosAccount.sequence,
//       fees: {
//         denom: UATOM,
//         amount: KAVAFEEAMOUNT,
//       },
//       gas: KAVAGAS,
//       memo: LEDGER_REWARDCLAIM_MEMO,
//       type: 'withdraw_delegation_reward',
//       msg,
//     };
//
//     const accountHDPATH = rootState.ledger.HDPATH;
//
//     const builder = Irisnet.getBuilder('cosmos');
//
//     // create a stdTx from the request object
//     const stdTx = builder.buildTx(JSON.parse(JSON.stringify(request)));
//
//     // user message
//     commit('ledger/SET_LEDGER_STATUS', 'Confirm Tx on your device', { root: true });
//
//     // get the portions of the tx to sign
//     const signBytes = stdTx.GetSignBytes();
//
//     // get the signatures from a ledger signing action
//     const sigs = await signMsg(accountHDPATH, signBytes);
//
//     // get the portion of the stdTx for attaching signature(s)
//     const txData = stdTx.GetData();
//
//     // attach signatures
//     txData.tx.signatures = sigs;
//
//     commit('ledger/SET_LEDGER_STATUS', 'Tx Sent! Click to Close', { root: true });
//
//     // send tx to node
//     const res = await postKavaSignedTx(txData);
//     commit('ledger/SET_TX_HASH', res.data.hash, {
//       root: true,
//     });
//   } catch (e) {
//     dispatch('errorMessage', e.toString());
//   }
// };
//
//
// export const checkKavaTxStatus = async ({ rootState, commit, dispatch }) => {
//   try {
//     const { txHash } = rootState.ledger;
//     const txResponse = await fetchKavaTxByHash(txHash);
//
//     dispatch(
//       'delegation/toggleLoadingModal',
//       {
//         visible: false,
//         header: '',
//         footer: '',
//       },
//       { root: true },
//     );
//
//     if (txResponse.logs[0].success === true) {
//       commit('delegation/SET_ACTIVE_DELEGATION_PROMPT', 'TxSuccessPrompt', {
//         root: true,
//       });
//     } else {
//       const txError = txResponse.logs.log;
//       dispatch('errorMessage', txError.toString());
//     }
//   } catch (e) {
//     dispatch('errorMessage', 'It is taking longer than usu
//     // al to confirm your transaction. We apologize for any inconvenience.');
//     const delay = 10000;
//
//     setTimeout(() => {
//       dispatch(
//         'checkKavaTxStatus',
//       );
//     }, delay);
//   }
// };
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#beginDelegation">beginDelegation</a></li><li><a href="global.html#beginIrisDelegation">beginIrisDelegation</a></li><li><a href="global.html#beginRedelegation">beginRedelegation</a></li><li><a href="global.html#beginUnbonding">beginUnbonding</a></li><li><a href="global.html#beginVoteTransaction">beginVoteTransaction</a></li><li><a href="global.html#buildSignSendCosmosTx">buildSignSendCosmosTx</a></li><li><a href="global.html#buildSignSendKavaTx">buildSignSendKavaTx</a></li><li><a href="global.html#checkIrisTxStatus">checkIrisTxStatus</a></li><li><a href="global.html#connectLedger">connectLedger</a></li><li><a href="global.html#endVoteTransaction">endVoteTransaction</a></li><li><a href="global.html#enrichCosmosAddresses">enrichCosmosAddresses</a></li><li><a href="global.html#enrichIrisAddresses">enrichIrisAddresses</a></li><li><a href="global.html#enrichKavaAddresses">enrichKavaAddresses</a></li><li><a href="global.html#enrichTerraAddresses">enrichTerraAddresses</a></li><li><a href="global.html#errorMessage">errorMessage</a></li><li><a href="global.html#fetchCosmosAccountAuthInfo">fetchCosmosAccountAuthInfo</a></li><li><a href="global.html#fetchCosmosAccountBalance">fetchCosmosAccountBalance</a></li><li><a href="global.html#fetchCosmosAddressDelegations">fetchCosmosAddressDelegations</a></li><li><a href="global.html#fetchCosmosAddressDelegationTxHistory">fetchCosmosAddressDelegationTxHistory</a></li><li><a href="global.html#fetchCosmosAddressUnbondingDelegations">fetchCosmosAddressUnbondingDelegations</a></li><li><a href="global.html#fetchCosmosDelegateValidatorRewards">fetchCosmosDelegateValidatorRewards</a></li><li><a href="global.html#fetchCosmosDelegationRewards">fetchCosmosDelegationRewards</a></li><li><a href="global.html#fetchCosmosDelegationUnbondingTxs">fetchCosmosDelegationUnbondingTxs</a></li><li><a href="global.html#fetchCosmosGovernanceProposals">fetchCosmosGovernanceProposals</a></li><li><a href="global.html#fetchCosmosGovProposalVotesByProposalId">fetchCosmosGovProposalVotesByProposalId</a></li><li><a href="global.html#fetchCosmosLatestBlock">fetchCosmosLatestBlock</a></li><li><a href="global.html#fetchCosmosStakingParameters">fetchCosmosStakingParameters</a></li><li><a href="global.html#fetchCosmosTxByHash">fetchCosmosTxByHash</a></li><li><a href="global.html#fetchCosmosValidatorSet">fetchCosmosValidatorSet</a></li><li><a href="global.html#fetchGovernanceProposals">fetchGovernanceProposals</a></li><li><a href="global.html#fetchIrisAccountAuthInfo">fetchIrisAccountAuthInfo</a></li><li><a href="global.html#fetchIrisAccountBalance">fetchIrisAccountBalance</a></li><li><a href="global.html#fetchIrisAddressDelegationHistory">fetchIrisAddressDelegationHistory</a></li><li><a href="global.html#fetchIrisAddressDelegations">fetchIrisAddressDelegations</a></li><li><a href="global.html#fetchIrisAddressUnbondingDelegations">fetchIrisAddressUnbondingDelegations</a></li><li><a href="global.html#fetchIrisDelegateValidatorRewards">fetchIrisDelegateValidatorRewards</a></li><li><a href="global.html#fetchIrisGovernanceProposals">fetchIrisGovernanceProposals</a></li><li><a href="global.html#fetchIrisGovProposalVotesByProposalId">fetchIrisGovProposalVotesByProposalId</a></li><li><a href="global.html#fetchIrisLatestBlock">fetchIrisLatestBlock</a></li><li><a href="global.html#fetchIrisNodeInfo">fetchIrisNodeInfo</a></li><li><a href="global.html#fetchIrisStakingParameters">fetchIrisStakingParameters</a></li><li><a href="global.html#fetchIrisTxByHash">fetchIrisTxByHash</a></li><li><a href="global.html#fetchIrisValidatorCandidates">fetchIrisValidatorCandidates</a></li><li><a href="global.html#fetchKavaAccountAuthInfo">fetchKavaAccountAuthInfo</a></li><li><a href="global.html#fetchKavaAccountBalance">fetchKavaAccountBalance</a></li><li><a href="global.html#fetchKavaAddressDelegations">fetchKavaAddressDelegations</a></li><li><a href="global.html#fetchKavaAddressDelegationTxHistory">fetchKavaAddressDelegationTxHistory</a></li><li><a href="global.html#fetchKavaAddressUnbondingDelegations">fetchKavaAddressUnbondingDelegations</a></li><li><a href="global.html#fetchKavaDelegateValidatorRewards">fetchKavaDelegateValidatorRewards</a></li><li><a href="global.html#fetchKavaDelegationRewards">fetchKavaDelegationRewards</a></li><li><a href="global.html#fetchKavaDelegationUnbondingTxs">fetchKavaDelegationUnbondingTxs</a></li><li><a href="global.html#fetchKavaGovernanceProposals">fetchKavaGovernanceProposals</a></li><li><a href="global.html#fetchKavaGovProposalVotesByProposalId">fetchKavaGovProposalVotesByProposalId</a></li><li><a href="global.html#fetchKavaLatestBlock">fetchKavaLatestBlock</a></li><li><a href="global.html#fetchKavaStakingParameters">fetchKavaStakingParameters</a></li><li><a href="global.html#fetchKavaTxByHash">fetchKavaTxByHash</a></li><li><a href="global.html#fetchKavaValidatorSet">fetchKavaValidatorSet</a></li><li><a href="global.html#fetchTerraAccountAuthInfo">fetchTerraAccountAuthInfo</a></li><li><a href="global.html#fetchTerraAccountBalance">fetchTerraAccountBalance</a></li><li><a href="global.html#fetchTerraAddressDelegations">fetchTerraAddressDelegations</a></li><li><a href="global.html#fetchTerraAddressDelegationTxHistory">fetchTerraAddressDelegationTxHistory</a></li><li><a href="global.html#fetchTerraAddressUnbondingDelegations">fetchTerraAddressUnbondingDelegations</a></li><li><a href="global.html#fetchTerraDelegateValidatorRewards">fetchTerraDelegateValidatorRewards</a></li><li><a href="global.html#fetchTerraDelegationRewards">fetchTerraDelegationRewards</a></li><li><a href="global.html#fetchTerraDelegationUnbondingTxs">fetchTerraDelegationUnbondingTxs</a></li><li><a href="global.html#fetchTerraGovernanceProposals">fetchTerraGovernanceProposals</a></li><li><a href="global.html#fetchTerraGovProposalVotesByProposalId">fetchTerraGovProposalVotesByProposalId</a></li><li><a href="global.html#fetchTerraLatestBlock">fetchTerraLatestBlock</a></li><li><a href="global.html#fetchTerraStakingParameters">fetchTerraStakingParameters</a></li><li><a href="global.html#fetchTerraTxByHash">fetchTerraTxByHash</a></li><li><a href="global.html#fetchTerraValidatorSet">fetchTerraValidatorSet</a></li><li><a href="global.html#getCosmosAddressFromPubkey">getCosmosAddressFromPubkey</a></li><li><a href="global.html#getIrisAddressFromPubkey">getIrisAddressFromPubkey</a></li><li><a href="global.html#getLedgerCosmosVersion">getLedgerCosmosVersion</a></li><li><a href="global.html#getLedgerPubKey">getLedgerPubKey</a></li><li><a href="global.html#govDeposit">govDeposit</a></li><li><a href="global.html#govVote">govVote</a></li><li><a href="global.html#pollLedgerDevice">pollLedgerDevice</a></li><li><a href="global.html#postSignedTx">postSignedTx</a></li><li><a href="global.html#processCosmosGovernanceProposals">processCosmosGovernanceProposals</a></li><li><a href="global.html#processIrisGovernanceProposals">processIrisGovernanceProposals</a></li><li><a href="global.html#queryCosmosProposals">queryCosmosProposals</a></li><li><a href="global.html#queryIrisProposals">queryIrisProposals</a></li><li><a href="global.html#requestWrapper">requestWrapper</a></li><li><a href="global.html#SET_COSMOS_ACCOUNT">SET_COSMOS_ACCOUNT</a></li><li><a href="global.html#SET_COSMOS_ADDRESS">SET_COSMOS_ADDRESS</a></li><li><a href="global.html#SET_COSMOS_PROPOSALS">SET_COSMOS_PROPOSALS</a></li><li><a href="global.html#SET_IRIS_ACCOUNT">SET_IRIS_ACCOUNT</a></li><li><a href="global.html#SET_IRIS_ADDRESS">SET_IRIS_ADDRESS</a></li><li><a href="global.html#SET_IRIS_PROPOSALS">SET_IRIS_PROPOSALS</a></li><li><a href="global.html#SET_KAVA_ACCOUNT">SET_KAVA_ACCOUNT</a></li><li><a href="global.html#SET_KAVA_ADDRESS">SET_KAVA_ADDRESS</a></li><li><a href="global.html#SET_TERRA_ACCOUNT">SET_TERRA_ACCOUNT</a></li><li><a href="global.html#SET_TERRA_ADDRESS">SET_TERRA_ADDRESS</a></li><li><a href="global.html#SET_VOTE_PROPOSAL">SET_VOTE_PROPOSAL</a></li><li><a href="global.html#signMsg">signMsg</a></li><li><a href="global.html#withdrawAllRewards">withdrawAllRewards</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Mon Mar 02 2020 21:59:03 GMT-0500 (Eastern Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
